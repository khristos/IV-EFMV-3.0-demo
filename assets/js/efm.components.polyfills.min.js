/*! efm-viewer v3.0.0 | (c) 2020 Illustrated Verdict | Illustrated Verdict License | https://github.com/khristos/IV-EFMV */
/*! efm-viewer v3.0.0 | (c) 2020 Illustrated Verdict | Illustrated Verdict License | https://github.com/khristos/IV-EFMV */
!(function(t,e){"function"==typeof define&&define.amd?define([],(function(){return e(t)})):"object"==typeof exports?module.exports=e(t):t.EFMViewer=e(t)})("undefined"!=typeof global?global:"undefined"!=typeof window?window:this,(function(t){"use strict";var e={media:".efm__media",loader:".efm__loader",controls:".efm__controls",timeline:".efm__timeline",timer:".efm__timer",controlBar:".efm__controlBar",mediaCollection:".efm__media-collection",mediaItemImage:".efm__media-item img",playButton:".efm__play-pause",playButtonState:{isPlaying:"mdi-pause",isPaused:"mdi-play"},seekBar:".efm__seek-bar",nextButton:".efm__next",backButton:".efm__previous",forwardTimeButton:".efm__forward",backwardTimeButton:".efm__backward",timerCurrent:".efm__timer-current",timerTotal:".efm__timer-total",playSpeed:document.querySelector(".efm__play-speed"),menuBar:".efm__menuBar",menuBarStrips:".dropdown-menu__strips",menuBarButton:".efm__menuBar-strip--title",menuBarDropdownItem:".dropdown-item",storageID:"efm__configData",templateStrip:EFM.Util.$("[data-efm-media-item]"),templateTimeline:document.querySelector("[data-efm-timeline]"),templateTimer:document.querySelector("[data-efm-timer]"),templateControlBar:document.querySelector("[data-efm-controlBar]"),templateLoader:document.querySelector("[data-efm-loader]"),templateMenuBar:document.querySelector("[data-efm-menuBar]")};return function(t,a){var n,i,r,o,d,s,l,u={},c=[],m=new Reef(null,{data:EFM.Util.getLocalData(e.storageID),lagoon:!0}),p=new Reef(t,{data:{speed:1,hasState:"is-loading"},template:function(t){console.log("RENDER PLAYER.");return'<div class="efm__controls" role="toolbar" aria-label="efm controls">\n                  <form class="efm__timeline columns is-centered no-margin-bottom"></form>\n                  <div class="efm__controlBar"></div>\n                  <div class="efm__menuBar has-text-justified flex-justify"></div>\n                </div>','<div class="efm__media"></div><div class="efm__controls" role="toolbar" aria-label="efm controls">\n                  <form class="efm__timeline columns is-centered no-margin-bottom"></form>\n                  <div class="efm__controlBar"></div>\n                  <div class="efm__menuBar has-text-justified flex-justify"></div>\n                </div>'},attachTo:[m]}),f=new Reef(e.media,{data:{duration:0,id:null,strips:m.data.configData.strips.strip,times:null,title:null},template:function(t){var a=e.templateStrip.innerHTML,n=EFM.Util.getStrip(t.strips,t.id),i=this.data.id=n.id,r=n.scans.scan.length>0?n.scans.scan:["NO SCANS FOUND."],o='<div class="efm__media-collection" data-efm-media-'+i+">";return this.data.title=n.title,this.data.times=EFM.Util.getStripTimes(n),r.forEach((function(t){o+=placeholders(a,t)})),o+="</div>",o+=`<div class="efm__loader" data-state="${p.data.hasState}"></div>`,console.group("STRIP DATA"),console.table(this.data),console.groupEnd(),o},attachTo:[m,p]}),v=(new Reef(e.timeline,{data:null,template:function(t){var a=e.templateTimeline.innerHTML;return placeholders(a,t)},attachTo:[m,p]}),new Reef(e.timer,{data:{timerCurrent:0,timerTotal:0},template:function(t){var a=e.templateTimer.innerHTML;return placeholders(a,t)},attachTo:[m,p]})),_=new Reef(e.controlBar,{data:{playPauseButton:e.playButton,hasState:e.playButtonState.isPaused},template:function(t){t.playPauseButton=t.playPauseButton.replace(".","");var a=e.templateControlBar.innerHTML;return placeholders(a,t)},attachTo:[m,p]}),g=(new Reef(e.loader,{data:null,template:function(t){var a=e.templateLoader.innerHTML;return placeholders(a,t)},attachTo:[m,p]}),new Reef(e.menuBar,{data:{title:" ",machine:{currentState:"inactive",states:{inactive:{on:{TOGGLE:"active"},attrs:{className:" ",ariaExpanded:"false"}},active:{on:{TOGGLE:"inactive"},attrs:{className:"is-active",ariaExpanded:"true"}}}}},template:function(t){this.data.title=f.data.title;var a=e.templateMenuBar.innerHTML,n="";return n+=placeholders(a,t)},attachTo:[m,p]})),T=new Reef(e.menuBarStrips,{data:{strips:m.data.configData.strips.strip},template:function(t){var e="";return t.strips.forEach((function(t){e+=`\n            <a class="dropdown-item strip-item border-bottom" data-strip-id="${t.id}">\n              ${t.title} - ${t.id}\n              <span class="dropdown-edit">\n                <i class="mdi mdi-lead-pencil strip-edit" title="Edit strip"></i>\n                <i class="mdi mdi-trash-can strip-delete" title="Delete strip"></i>\n              </span>\n            </a>\n          `})),e+='\n        <div class="dropdown-new border-bottom editing-strip">\n          <input type="text" class="dropdown-menu__new-input" placeholder="output filename..."> \n          <a class="has-text-primary strip-save-changes">Save</a>\n        </div>\n        '},attachTo:[m,p]});u.setup=function(){p.render(),u.animate(),w()},u.animate=function(){S(),console.group("SETTINGS (EFMViewer)"),console.log(n),console.groupEnd()};var S=function(){(i=document.querySelector(n.mediaCollection)).style.whiteSpace="nowrap",r=[].slice.call(i.querySelectorAll(n.mediaItemImage)),o=0,imagesLoaded(r,E)},E=function(){delete EFM.Util.$(n.loader).dataset.state,o=r.map((function(t){return t.clientWidth})).reduce((function(t,e){return t+e}))-i.clientWidth<<0,console.group("MARQUEE"),console.log("# items: ",r.length,";\nViewport width: ",i.clientWidth+";\nDisplacement (total content width): ",o),console.groupEnd(),B()},B=function(){n.playButton,l=document.querySelector(n.seekBar);var t=p.getData(),e=f.data.times.mediaStartTime,a=f.data.times.mediaEndTime;f.data.duration=(a-e)/t.speed,c[f.data.id]||(c[f.data.id]=anime.timeline({loop:!1,easing:"linear",run:function(t){},complete:function(t){},update:function(t){l.value=c[f.data.id].progress,l.setAttribute("aria-valuenow",l.value),v.setData({timerCurrent:EFM.Util.secondsToHms(t.currentTime/1e3+e/1e3)||0})},autoplay:!1}),c[f.data.id].add({targets:i,translateX:[{value:-o}],duration:function(){return f.data.duration},loop:!0,offset:0}),g.setData({attrs:{className:" ",ariaExpanded:"false"}}),k())},h=function(t){t&&t.preventDefault();var e=f.data;!0===c[e.id].paused?(c[f.data.id].play(),_.setData({hasState:n.playButtonState.isPlaying})):(c[e.id].pause(),_.setData({hasState:n.playButtonState.isPaused})),x("_playMarquee - isPaused: "+c[e.id].paused),k()},y=function(){c[f.data.id]&&!0!==c[f.data.id].paused&&(c[f.data.id].pause(),_.setData({hasState:n.playButtonState.isPaused}))},w=function(){events.on("click",n.playButton,h),["input","change"].forEach((function(t){document.addEventListener(t,D,!1)})),document.querySelector(e.media),document.addEventListener("click",M,!1),document.addEventListener("click",b,!1),document.addEventListener("click",L,!1),document.addEventListener("click",F,!1),U()},D=function(t){var e=f.getData();t.target.closest(n.seekBar)&&(c[e.id].pause(),c[e.id].seek(c[e.id].duration*(l.value/100)),_.setData({hasState:n.playButtonState.isPaused}),v.render())},M=function(t){t.preventDefault();var e=t.target.closest(n.forwardTimeButton);if(e){0===c[f.data.id].currentTime&&c[f.data.id].play(),y();var a=parseInt(e.dataset.offset);c[f.data.id].seek(c[f.data.id].currentTime+6e4*a),I(),x()}},b=function(t){t.preventDefault();var e=f.getData(),a=t.target.closest(n.backwardTimeButton);if(a){0===c[e.id].currentTime&&c[e.id].play(),y();var i=Number.parseInt(a.dataset.offset);c[e.id].pause(),_.setData({hasState:n.playButtonState.isPaused}),c[e.id].seek(c[e.id].currentTime-6e4*i),I(),x()}},x=function(t){var e=f.data;console.group("ANIMATION PROGRESS",t||""),console.log("stripData.id: \t\t",e.id,"\nseekBar.value: \t\t",l.value,"%","\nanimations.progress: ",c[e.id].progress,"\nanimations.duration: ",c[e.id].duration,"\nanimations.currentTimeMS: ",c[e.id].currentTime,"\nanimations.currentTimeHMS: ",EFM.Util.secondsToHms(c[e.id].currentTime/1e3+f.data.times.mediaStartTime/1e3),"\nanimations.id: ",c[e.id].id),console.groupEnd()},I=function(){console.group("ANIMATIONS"),console.log("Instances: ",c,";\nAnimation ID: ",c[f.data.id].id,";\nStrip ID: ",f.data.id,";\nInstance duration: ",c[f.data.id].duration),console.groupEnd()},L=function(t){if(t.preventDefault(),t.target.closest(n.menuBarButton)){var e=g.data.machine,a=EFM.Util.transition(g,e.currentState,"TOGGLE");console.group("STATE (MenuBar): ",a,"\n",e.states[a]),console.groupEnd();var i=e.states[a].attrs.className,r=e.states[a].attrs.ariaExpanded;e.currentState=a,g.setData({attrs:{className:i,ariaExpanded:r}}),T.render()}},F=function(t){if(t.preventDefault(),t.target.closest(n.menuBarDropdownItem)){var e=t.target.getAttribute("data-strip-id"),a=g.data.machine,i=EFM.Util.transition(g,a.currentState,"TOGGLE");console.groupCollapsed("STATE (MenuBar): ",i,"\n",a.states[i]),console.groupEnd();var r=a.states[i].attrs.className,o=a.states[i].attrs.ariaExpanded;y(),f.setData({id:e}),a.currentState=i,g.setData({attrs:{className:r,ariaExpanded:o},title:f.data.title}),S(),c[f.data.id]&&(l.value=c[f.data.id].progress,l.setAttribute("aria-valuenow",l.value),c[f.data.id].seek(c[f.data.id].currentTime),k(),I(),x())}},k=function(){f.data;if(c[f.data.id]){var t=f.data.times.mediaStartTime,e=f.data.times.mediaEndTime;d=EFM.Util.secondsToHms(c[f.data.id].currentTime/1e3+t/1e3)||EFM.Util.secondsToHms(t/1e3),s=EFM.Util.secondsToHms(e/1e3)||0,v.setData({timerCurrent:d,timerTotal:s})}},U=function(){var t=document.querySelector(e.media),a=document.querySelector(e.mediaCollection),n=0;new ScrollBooster({viewport:t,content:a,bounce:!1,friction:.75,onUpdate:t=>{y(),c[f.data.id]&&(n=c[f.data.id].progress=100*Math.abs(-t.position.x/o)||c[f.data.id].progress,l.value=n,c[f.data.id].progress=n,c[f.data.id].currentTime=n/100*c[f.data.id].duration,a.style.transform=`translateX(\n              ${-t.position.x}px\n            )`,c[f.data.id]&&(c[f.data.id].currentTime=l.value/100*c[f.data.id].duration,c[f.data.id].progress=l.value,k(),I(),x()))}})};return u.init=function(t){n=EFM.Util.extend(e,t||{}),u.setup()},u.init(a),u}}));var defaultViewer=function(){EFM.Util.getXHRData.call(this,(function(){return new EFMViewer("[data-efm-viewer]",{})}))};EFM.Util.ready(document,defaultViewer);